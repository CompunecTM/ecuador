{include="header"}

<div class="container">
	<nav>
		<h1>Nuevo Ingreso</h1>
		<ol class="breadcrumb">
		  <li><a href="#">Contabilidad</a></li>
		  <li><a href="#">Ingreso</a></li>
		  <li class="active">Nuevo Ingreso</li>
		</ol>
	</nav>
	<form action="">
	<div class="jumbotron"  style="border: 1px solid #DDDDDD">
{if="$fsc->nuevo_ingreso()==true"}
	{loop="$fsc->nuevo_ingreso()"}
	<div class="form-group ">
		<div class="row ">

			<input type="hidden" placeholder="Numero de Ingreso" name="numero_i" id="numero_i" class="form-control">	
			<div class="col-sm-7 ">
				<label for="cliente">Cliente</label>
				<input type="text" placeholder="Numero de Ingreso" name="cliente" id="cliente" class="form-control" value="{$value['nombre']}"  autocomplete="off" >
			</div>		
			<div class="col-sm-2 ">
				<label for="fecha">Fecha</label>
				<input type="text" placeholder="Numero de Ingreso" name="fecha" id="fecha" class="form-control datepicker"  autocomplete="off">
			</div>			
			<div class="col-sm-3 ">
				<label for="t_ingreso">Tipo de Ingreso</label>
				<select class="form-control" id="t_ingreso">
					<option value='none'>Seleccione</option>
					<option value='D'>Ingreso directo</option>
					<option value='P'>Pedido</option>
					<option value='R'>Retención</option>
				</select>
			</div>
		</div>
	</div>
{/if}
	{/loop}
	<div class="form-group ">
		<div class="row ">
			<div class="col-sm-8 ">
				<label for="numero_i">Descripcion</label>
				<input type="text" placeholder="Numero de Ingreso" name="numero_i" id="numero_i" class="form-control">
			</div>
			<div class="col-sm-4 ">
				<label for="referencia">Referencia</label>
				<input type="text" placeholder="Numero de Ingreso" name="referencia" id="referencia" class="form-control">
			</div>
		</div>
	</div>
	</div>
	<div class="form-group tingresod" style="display: none">
		<h3>Ingreso directo</h3>
		<hr>
		<div class="row">
			
		</div>
	</div>
{if="$fsc->listar_pedido()==true"}
	<div class="form-group tingresop" style="display: none">
		<h3>Pedido</h3>
		<hr>
		<div class="row">
			<table class="table table-hover">
		      <thead>
		         <tr>
		            <th></th>
		            <th class="text-left">Código</th>
		            <th class="text-left">Cliente</th>
		            <th class="hidden-sm"></th>
		            <th class="text-left" style="min-width:40%;">Observaciones</th>
		            <th class="text-right">Monto</th>
		            <th class="text-center">Fecha</th>
		            <th style="width: 50px;">Seleccione</th>
		         </tr>
		      </thead>
		     <tbody>
		     	{loop="$fsc->listar_pedido()"}
		     		<tr>
			     		<td></td>
						<td>{$value['codigo']}</td>
						<td class="text-left" >{$value['nombrecliente']}</td>
						<td></td>
						<td style="min-width:40%;">{$value['observaciones']}</td>
						<td class="text-right"><input data-max="{$value['total']}"  name="monto" class="text-right monto" id="{$value['codigo']}" value="{$value['total']}" disabled="none" ></td>
						<td class="text-center">{$value['fecha']}</td>
						<td class="text-center"><input type="checkbox" data-ide="{$value['codigo']}"/></td>
					</tr>
		     	{/loop}
		     	</tr>
		     </tbody>
		  	</table>
		</div>
		<div class="row">
			<div class="col-md-3 col-md-offset-9"><hr></div>
			<div class="col-md-3 col-md-offset-9">				
				<label for="">Total $</label><div class="total" data-monto='0'><h3>0</h3></div>
				<input type="hidden" name="total" value="0" />
			</div>
		</div>
		<br>
		<div class="row text-right">
			<button class="btn btn-sm btn-primary" type="button">
               <span class="glyphicon glyphicon-floppy-disk"></span>&nbsp; Guardar...
            </button>
		</div>
{/if}
	<div class="form-group tingresor" style="display: none">
		<h3>Retención</h3>
		<hr>
		<div class="row">
			
		</div>
	</div>
	</form>
</div>
{if="$fsc->nuevo_ingreso()==false"}
<script type="text/javascript">
   $(document).ready(function() {
      $("#modal_cliente").modal('show');
      document.f_nueva_venta.ac_cliente.focus();

      $("#ac_cliente").autocomplete({
         serviceUrl: 'index.php?page=nueva_venta&tipo=pedido',
         paramName: 'buscar_cliente',
         onSelect: function (suggestion) {
            if(suggestion)
            {
               if(document.f_nueva_venta.cliente.value != suggestion.data)
               {
                  document.f_nueva_venta.cliente.value = suggestion.data;
               }
            }
         }
      });
   });
</script>
<div class="modal in" id="modal_cliente" style="display: block; padding-right: 17px;">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h4 class="modal-title">
               <span class="glyphicon glyphicon-search"></span>
               &nbsp; Selecciona el cliente
            </h4>
            <p class="help-block">
               Busca y selecciona el cliente o bien crea uno nuevo usando
               el recuadro en azul. Además, puedes cambiar las
               <a href="index.php?page=ventas_clientes_opciones">opciones para nuevos clientes</a>.
            </p>
         </div>
         <div class="modal-body">
            <form name="f_nueva_venta" action="index.php?page=contabilidad_ingreso&amp;tipo=ingreso" method="post" class="form">
               <input type="hidden" name="cliente">
               <div class="form-group">
                  <div class="input-group">
                     <input class="form-control" type="text" name="ac_cliente" id="ac_cliente" placeholder="Buscar" autocomplete="off">
                     <span class="input-group-btn">
                        <button class="btn btn-primary" type="submit" onclick="this.disabled=true;this.form.submit();">
                           <span class="glyphicon glyphicon-share-alt"></span>
                        </button>
                     </span>
                  </div>
               </div>
            </form>
         </div>
         <div class="modal-body bg-info">
            <form action="index.php?page=nueva_venta&amp;tipo=pedido" method="post" class="form-horizontal">
               <input type="hidden" name="cliente">
               <div class="form-group">
                  <label class="col-sm-2 control-label">Nombre</label>
                  <div class="col-sm-10">
                     <input type="text" name="nuevo_cliente" class="form-control" placeholder="Nuevo cliente" autocomplete="off" required="">
                  </div>
               </div>
               <div class="form-group">
                  <label class="col-sm-2 control-label">Cedula</label>
                  <div class="col-sm-3">
                     <select name="nuevo_tipoidfiscal" class="form-control">
                        
                        
                        <option value="Cedula">Cedula</option>
                        
                        <option value="R.U.C">R.U.C</option>
                        
                        <option value="Pasaporte">Pasaporte</option>
                        
                     </select>
                  </div>
                  <div class="col-sm-7">
                     
                     <input type="text" name="nuevo_cifnif" class="form-control" maxlength="30" autocomplete="off">
                     
                     <label class="checkbox-inline">
                        <input type="checkbox" name="personafisica" value="TRUE" checked=""> Persona física (no empresa)
                     </label>
                  </div>
               </div>    
               <div class="text-right">
                  <button class="btn btn-sm btn-primary" type="submit">
                     <span class="glyphicon glyphicon-floppy-disk"></span>&nbsp; Guardar y seleccionar
                  </button>
               </div>
            </form>
         </div>
      </div>
   </div>
</div>
{/if}
<script>
	$('#t_ingreso').change(function() {
	if ($(this).val()=='D') {
		$('.tingresop').hide();
		$('.tingresor').hide();
		$('.tingresod').show();
		$('#referencia').val('');

	} else if ($(this).val()=='P') {
		$('.tingresop').show();
		$('.tingresor').hide();
		$('.tingresod').hide();
		$('#referencia').val('');
	} else if ($(this).val()=='R') {
		$('.tingresop').hide();
		$('.tingresor').show();
		$('.tingresod').hide();
		$('#referencia').val('');
	}
	});

	$('input[type="checkbox"]').click(function() {

		var total=$('.total').data('monto');

		if( $(this).prop('checked') ) {

			$('#'+$(this).data('ide')).each(
				function(index, value) {
					$(this).removeAttr('disabled');
				}
			);

		    total = total + parseInt($('#'+$(this).data('ide')).val());
		    $('.total').data('monto',total);
		    $('.total').empty();
		    $('.total').append('<h3>'+total+'</h3>');
		    $('input[name="total"]').attr('value',total);

		}else{

			total = total - parseInt($('#'+$(this).data('ide')).val());
			$('.total').data('monto',total);
			$('.total').empty();
		    $('.total').append('<h3>'+total+'</h3>');
		    $('input[name="total"]').attr('value',total);
		    $('#'+$(this).data('ide')).each(
				function(index, value) {
					$(this).attr('disabled', 'disabled'); 
				}
			);
		}
	});

	$('.monto').keyup(function() {
		if ($(this).data('max')<$(this).val()) 
		{
			importe_total = 0;
			$(this).val($(this).data('max'));
		 	alert("El monto no puede ser mayor de "+$(this).data('max')+" para este pedido");
		 	$('.total').empty();
		 	$(".monto").each(
					function(index, value) {
						if (!$(this).prop('disabled')) {
							importe_total = importe_total + parseInt($(this).val());
						}
					}
				); 
			$('input[name="total"]').attr('value',importe_total);
			$('.total').data('monto',importe_total);
			$('.total').append('<h3>'+importe_total+'</h3>');
		} else {			
				codigo = $(this).attr('id');
				importe_total = 0;
				$('.total').empty();
				$(".monto").each(
					function(index, value) {
						if (!$(this).prop('disabled')) {
							importe_total = importe_total + parseInt($(this).val());
						}
					}
				); 
			$('input[name="total"]').attr('value',importe_total);
			$('.total').data('monto',importe_total);
			$('.total').append('<h3>'+importe_total+'</h3>');
		}
	});
</script>
{include="footer"}